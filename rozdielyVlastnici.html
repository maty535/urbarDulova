<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit podielov vlastn√≠kov</title>
    <style>
        @media (max-width: 600px) {

            .quick-note {
                font-size: 1.05rem; /* ƒåitateƒænej≈°ie na mobile */
            }
            /* 1. HLAVIƒåKA: D√°tum pod nadpisom, bez prekr√Ωvania */
            div[style*="position: relative"] {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                padding-bottom: 15px !important;
            }
            span[style*="position: absolute"] {
                position: static !important;
                transform: none !important;
                margin-top: 8px;
            }

            /* Kƒæ√∫ƒçov√° zmena pre oddelenie riadkov */
            .share-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                padding: 12px 5px !important;
                background: transparent !important; /* ƒåist√© biele pozadie */
                border-bottom: 1px solid #b91c1c !important; /* Tenk√°, ale ostr√° ƒçerven√° ƒçiara */
            }

            .share-row:last-child {
                border-bottom: none !important; /* Posledn√Ω riadok v r√°mci jedn√©ho vlastn√≠ka u≈æ ƒçiaru nepotrebuje */
            }
            /* 3. D√ÅTA: Ka≈æd√© na svojom riadku */
            .fraction-col, .percent-col, .lv-info {
                width: 100% !important;
                padding: 4px 0 !important;
                text-align: center !important;
                border: none !important;
            }

            /* 2. SKRYTIE TEXTU "na listoch:" */
            /* V tvojom renderi je to v <span style="color: var(--text-muted)">na listoch:</span> */
            .lv-info span[style*="color: var(--text-muted)"],
            .dob-tag span[style*="color: var(--text-muted)"] {
                display: none !important;
            }

            .percent-col {
                color: var(--primary-color) !important;
                font-size: 1.2rem !important;
                font-weight: 800 !important;
            }

        .lv-numbers {
                font-size: 1.25rem !important;
                display: block;
                margin-top: 5px;
            }
            /* Z√°kladn√Ω ≈°t√Ωl pre ikonu */
            .lv-icon {
                color: var(--primary-color); /* Pou≈æije tvoju ƒçerven√∫ */
                font-weight: bold;
                margin-right: 8px;
            }
            /* ≈†√≠pka na mobile m√¥≈æe by≈• o nieƒço v√§ƒç≈°ia pre lep≈°iu navig√°ciu oka */
            .lv-icon {
                font-size: 1.2rem;
                display: inline-block;
                vertical-align: middle;
            }
            .lv-arrow {
                font-size: 1.5rem;
                display: inline-block !important; /* Na mobile sa ≈°√≠pka zobraz√≠ */
                color: #b91c1c; /* Ostr√° ƒçerven√° */
                margin-right: 5px;
                vertical-align: middle;
                font-weight: 900;
            }
        }
        /* ================================================================================*/
        /* 1. Z√ÅKLADN√â NASTAVENIE (Desktop) */
        .quick-note {
            white-space: pre-wrap; /* KƒΩ√öƒåOV√â: zachov√° riadkovanie a entery */
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            margin: 10px 0;
            line-height: 1.5; /* Lep≈°ia ƒçitateƒænos≈• */
        }
        
        .btn-edit-note {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 5px;
        }

        /* Aby text vn√∫tri markdownu nevyzeral rozbit√Ω */
        .markdown-text p {
            margin: 0 0 8px 0; /* Jemn√Ω odstup pod odsekmi */
            display: inline;   /* Ak chce≈°, aby ikona üìù zostala v riadku s textom */
        }
        
        .markdown-text strong {
            color: #000;
            font-weight: 700;
        }
        
        .markdown-text ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .markdown-text a {
            color: #2563eb;
            text-decoration: underline;
        }
        .lv-arrow { display: none;}  /* ≈†√≠pka je predvolene skryt√° */
        :root { --primary-color: #b91c1c; --bg-body: #f8fafc; --text-muted: #64748b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 40px; background: var(--bg-body); color: #334155; }
        .container { max-width: 1150px; margin: auto; }
        
        h1 { font-size: 2.2rem; color: var(--primary-color); margin-bottom: 5px; font-weight: 800; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .sub-header { font-size: 1.1rem; color: #475569; margin-bottom: 25px; font-weight: 600; }
        
        .search-box { width: 100%; padding: 12px 20px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; margin-bottom: 25px; outline: none; box-sizing: border-box; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 6px solid var(--primary-color); position: relative; }
        .owner-name { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
        
        /* Spoloƒçn√Ω ≈°t√Ωl pre interakt√≠vne ≈°t√≠tky */
        .tag { display: inline-block; padding: 3px 10px; border-radius: 6px; font-weight: 700; font-size: 0.85rem; margin-left: 10px; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; }
        
        .maiden-tag { background: #fef2f2; color: #b91c1c; border-color: #fee2e2; }
        .maiden-tag:hover { background: #fee2e2; transform: translateY(-1px); }
        
        .dob-tag { background: #f1f5f9; color: #475569; border-color: #e2e8f0; font-style: normal !important; }
        .dob-tag:hover { background: #e2e8f0; color: #1e293b; transform: translateY(-1px); }

        .mismatch-box { background: #fff5f5; border: 1px solid #fee2e2; border-radius: 10px; margin-top: 15px; overflow: hidden; }
        
        .share-row { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid #fee2e2; }
        .share-row:last-child { border-bottom: none; }

        .fraction-col { width: 100px; display: flex; justify-content: center; }
        .percent-col { width: 140px; font-family: 'Courier New', monospace; font-weight: 700; color: #b91c1c; font-size: 1.05rem; text-align: right; padding-right: 35px; }

        .lv-info { flex: 1; font-size: 1.05rem; border-left: 2px solid #fee2e2; padding-left: 25px; }
        .lv-numbers { font-weight: 700; color: var(--primary-color); }

        .fraction { display: inline-flex; flex-direction: column; vertical-align: middle; align-items: center; font-size: 0.95em; line-height: 1.1; font-weight: bold; }
        .fraction .num { border-bottom: 1.5px solid #1e293b; padding: 0 3px; }
        .fraction .den { padding: 0 3px; }
        .nema-val { font-weight: 800; color: #64748b; font-size: 1.1rem; }

      .notes-wrapper {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .note-card {
            background: #fff9c433; /* Veƒæmi jemn√° ≈ælt√° ako na obr√°zku */
            border: 1px solid #fbc02d; /* Oran≈æovo-≈ælt√Ω okraj */
            border-left: 4px solid #fbc02d; /* Hrub≈°√≠ okraj vƒæavo */
            border-radius: 4px;
            padding: 10px 12px;
        }
        
        .note-body {
            font-size: 0.95rem;
            color: #333;
            line-height: 1.5;
            position: relative;
        }
        
        .note-icon {
            margin-right: 5px;
        }
        
        .note-date-footer {
            font-size: 0.7rem;
            color: #999;
            text-align: right;
            margin-top: 5px;
            font-family: sans-serif;
        }
        /* Modr√° bodka pri mene */
        .note-indicator {
            width: 8px;
            height: 8px;
            background-color: #3b82f6;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 2px #fff, 0 0 5px rgba(59, 130, 246, 0.5);
            animation: pulse-blue 2s infinite;
        }
        
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Tlaƒçidlo "Zobrazi≈• pozn√°mky" */
        .btn-show-notes {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-show-notes:hover {
            background: #e2e8f0;
        }

        .filter-btn {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .filter-btn:hover {
            background: #f1f5f9;
            border-color: #94a3b8;
        }
        
        .filter-btn.active {
            background: #1e293b;
            color: white;
            border-color: #1e293b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Modr√Ω Badge s ƒç√≠slom */
.note-badge {
    background-color: #3b82f6;
    color: white;
    font-size: 0.7rem;
    font-weight: 800;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    cursor: help;
    flex-shrink: 0;
}

    /* ≈†t√Ωl pre mal√© ƒç√≠sla v tlaƒçidl√°ch */
    .filter-btn small {
        margin-left: 4px;
        opacity: 0.7;
    }
    
    .filter-btn.active small {
        opacity: 1;
    }
    
    /* Anim√°cia pulzovania len ak je to d√¥le≈æit√© (voliteƒæn√©) */
    .note-badge {
        animation: badge-pop 0.3s ease-out;
    }
    
    @keyframes badge-pop {
        0% { transform: scale(0.5); }
        100% { transform: scale(1); }
    }
 .filter-row {
    display: flex;
    justify-content: space-between; /* Toto rozdel√≠ vƒæavo a vpravo */
    align-items: center;
    width: 100%;
    margin-bottom: 25px;
    gap: 15px;
}

.filter-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

    .btn-refresh {
        background: #fff;
        border: 1px solid #cbd5e1;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #475569;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
        white-space: nowrap; /* Aby sa text nezalamoval */
    }
    
    .btn-refresh:hover {
        background: #f1f5f9;
        border-color: #3b82f6;
        color: #3b82f6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    /* Anim√°cia pre Font Awesome ikonu */
    .refresh-icon {
        font-size: 0.9rem;
        transition: transform 0.5s ease;
    }
    
    .loading .refresh-icon {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Responzivita pre mobil */
    @media (max-width: 650px) {
        .filter-row {
            flex-direction: column;
            align-items: flex-start;
        }
        .btn-refresh {
            align-self: flex-end; /* Na mobile zostane vpravo dole pod filtrami */
        }
    }

    .info-trigger {
        color: #94a3b8; /* Jemnej≈°ia siv√°, aby neru≈°ila nadpis */
        font-size: 1rem; /* O nieƒço men≈°ia ako text nadpisu */
        cursor: pointer;
        padding: 5px; /* Zv√§ƒç≈°uje "klikateƒæn√∫" plochu bez zmeny poz√≠cie */
        transition: all 0.2s ease;
        
        /* Polohovanie nahor */
        align-self: flex-start; 
        margin-top: 5px; /* Dolad√≠≈° podƒæa toho, ako vysoko ju chce≈° ma≈• */
    }
    
    .info-trigger:hover {
        color: #3b82f6; /* Pri prejden√≠ my≈°ou zmodrie */
        transform: scale(1.1);
    }

/* Anim√°cia pre Info Box (aby sa pekne zjavil) */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<div class="container">
    <div style="position: relative; border-bottom: 2px solid var(--primary-color); margin-bottom: 25px; padding-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
        <h1 style="margin: 0; border-bottom: none; padding: 0;">Nekonzistencie v podieloch vlastn√≠kov</h1>
        <span style="background: #1e293b; color: white; padding: 5px 15px; border-radius: 6px; font-size: 0.85rem; font-weight: 800; letter-spacing: 0.5px; white-space: nowrap;">
            STAV K 28. 02. 2026
        </span>
    </div>
    <div class="sub-header" id="stats">Naƒç√≠tavam d√°ta...</div>
    
    <input type="text" id="search" class="search-box" placeholder="Hƒæada≈• podƒæa mena, rodn√©ho mena alebo d√°tumu..." onkeyup="doSearch()">
    <div class="filter-row">
        <div class="filter-group">
            <button onclick="setNoteFilter('all')" class="filter-btn active" id="filter-all">
                V≈°etci <small id="count-all"></small>
            </button>
            <button onclick="setNoteFilter('with')" class="filter-btn" id="filter-with">
                S pozn√°mkou <small id="count-with"></small>
            </button>
            <button onclick="setNoteFilter('without')" class="filter-btn" id="filter-without">
                Bez pozn√°mky <small id="count-without"></small>
            </button>
        </div>
    
        <button onclick="refreshData()" class="btn-refresh" id="refresh-btn">
            <i class="fa-solid fa-arrows-rotate refresh-icon"></i>
            <span class="refresh-text">Aktualizova≈•</span>
        </button>
    </div>

    <div id="legal-info-box" style="display: none; background: #eff6ff; border: 1px solid #bfdbfe; border-left: 5px solid #3b82f6; padding: 20px; border-radius: 8px; margin-bottom: 25px; color: #1e3a8a; position: relative; animation: fadeIn 0.3s ease;">
    <button onclick="toggleInfoBox()" style="position: absolute; top: 10px; right: 10px; border: none; background: none; cursor: pointer; font-size: 1.2rem; color: #3b82f6;">&times;</button>
    <h3 style="margin-top: 0; color: #1e40af; display: flex; align-items: center; gap: 8px;">
        <i class="fa-solid fa-circle-info"></i>Pr√°vny z√°klad a metodika
    </h3>
        <p><b>Z ƒçoho vypl√Ωva ta nekonzistencia a preƒço maj√∫ niektor√≠ vlastn√≠ci v√¥bec nieƒço upravi≈• alebo opravi≈• ?</b></p>
        <p style="font-size: 0.95rem; line-height: 1.6; margin-bottom: 10px;">
            Pr√°vne komfortn√Ω stav vy≈æaduje, aby mal spoluvlastn√≠k v r√°mci spoloƒçnej nehnuteƒænosti <strong>toto≈æn√Ω podiel na v≈°etk√Ωch pozemkoch</strong>, ktor√© t√∫to nehnuteƒænos≈• tvoria.
        </p>
        <p style="font-size: 0.95rem; line-height: 1.6; margin-bottom: 10px;">
            Tento princ√≠p vypl√Ωva zo <strong>z√°kona o pozemkov√Ωch spoloƒçenstv√°ch</strong> a judik√°tov s√∫dov. Nezrovnalosti vznikli historicky chybami v evidencii, nespr√°vnou aplik√°ciou z√°kona pri dediƒçsk√Ωch konaniach alebo neskor≈°√≠mi re≈°tit√∫ciami.
        </p>
    <small style="opacity: 0.8;">Zdroj: <a href="https://www.slov-lex.sk/ezbierky/pravne-predpisy/SK/ZZ/2013/97/">Z√°kon o pozemkov√Ωch spoloƒçenstv√°ch 97/2013</a> a <a href="https://www.slov-lex.sk/sudne-rozhodnutia/judikaty/774da6a5-9443-4615-86c3-504618587aed">Judikat√∫ra s√∫dov SR</a></small>
</div>
    
    <div id="results"></div>
</div>

<script>
    let ownersData  = [];
    let globalNotes = {};  // Glob√°lna premenn√° pre pozn√°mky

    function formatFraction(shareStr) {
        if (shareStr === "Nem√°") return '<div class="nema-val">Nem√°</div>';
        const match = shareStr.match(/{(\d+)}{(\d+)}/);
        if (match) return `<div class="fraction"><span class="num">${match[1]}</span><span class="den">${match[2]}</span></div>`;
        return shareStr;
    }

    // Univerz√°lna funkcia pre nastavenie filtra
    function setFilter(value) {
        const searchInput = document.getElementById('search');
        searchInput.value = value;
        doSearch();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function generateOwnerId(name, dob) {
        return `${name}-${dob}`
            .toLowerCase()
            .normalize("NFD")                // Rozlo≈æ√≠ znaky (√° -> a + ¬¥)
            .replace(/[\u0300-\u036f]/g, "") // Odstr√°ni diakritick√© znamienka
            .replace(/\s+/g, '-')            // Medzery nahrad√≠ pomlƒçkami
            .replace(/[^a-z0-9-]/g, '');     // Odstr√°ni v≈°etko ostatn√© okrem alfanumeriky a pomlƒçiek
    }

    function removeAccents(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }
   function render(data, notesInfo = {}) {
    const out = document.getElementById('results');
    let html = "";

    data.forEach(item => {
        // Generujeme ID (uisti sa, ≈æe tvoja funkcia generateOwnerId pou≈æ√≠va rovnak√Ω XOR kƒæ√∫ƒç)
        const ownerId = generateOwnerId(item.name, item.dob);
        
        // Vo vn√∫tri render(data, notesInfo) v cykle:
        const info = notesInfo[ownerId];
        const hasNotes = info && info.count > 0;

       html += `
                <div class="card" id="card-${ownerId}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="owner-name">${item.name}</span>
                            
                            ${hasNotes ? `
                                <span class="note-badge" onclick="toggleInfoBox()" style="cursor:help" title="Kliknite pre info o metodike">
                                    ${info.count}
                                </span>
                            ` : ''}
            
                            ${item.maiden ? `<span class="tag maiden-tag" onclick="setFilter('${item.maiden}')" title="Filtrova≈• rodn√© meno">r. ${item.maiden}</span>` : ''}
                        </div>
                        <div class="tag dob-tag" onclick="setFilter('${item.dob}')" title="Filtrova≈• d√°tum narodenia">
                            <span style="color: var(--text-muted)">Nar.:</span> ${item.dob}
                        </div>
                    </div>
            
                    <div class="mismatch-box">
                        ${item.details.map(d => {
                            const pMatch = d.share.match(/\(([\d\.]+)%\)/);
                            const percent = pMatch ? pMatch[1] : "";
                            return `
                                <div class="share-row">
                                    <div class="fraction-col">${formatFraction(d.share)}</div>
                                    <div class="percent-col">${percent ? percent + ' %' : ''}</div>
                                    <div class="lv-info">
                                        <span class="lv-arrow">‚Üì</span>
                                        <span class="lv-label" style="color: var(--text-muted)">na listoch:</span>
                                        <span class="lv-numbers">${d.lvs.join(', ')}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
            
                    <div id="notes-list-${ownerId}" class="dynamic-notes-container"></div>
            
                    <div id="edit-ctrl-${ownerId}" style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            ${hasNotes ? `
                                <button class="btn-show-notes" onclick="loadCommentsForOwner('${ownerId}', '${info.url}')">
                                     Zobrazi≈• pozn√°mky (${info.count})
                                </button>
                            ` : '<span></span>'}
                        </div>
                        <button class="btn-edit-note" onclick="activateUtterances('${ownerId}')">
                            ${hasNotes ? 'Upravi≈•' : '+ Prida≈• pozn√°mku'}
                        </button>
                    </div>
                </div>
            `;
        }); 

        out.innerHTML = html;
    }

    function toggleInfoBox() {
        const box = document.getElementById('legal-info-box');
        if (box.style.display === 'none') {
            box.style.display = 'block';
            box.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            box.style.display = 'none';
        }
    }

    // 3. Funkcia, ktor√° aktivuje plnohodnotn√© Utterances pri kliknut√≠ na tlaƒçidlo
    function activateUtterances(ownerId) {
        const container = document.getElementById(`edit-ctrl-${ownerId}`);
        container.innerHTML = '<p style="font-size:0.8rem; color:var(--text-muted)">Naƒç√≠tavam editor...</p>';
        
        const script = document.createElement('script');
        script.src = "https://utteranc.es/client.js";
        script.setAttribute('repo', 'maty535/urbarDulova'); // <--- SEM DOPL≈á SVOJE
        script.setAttribute('issue-term', ownerId);
        script.setAttribute('label', 'pozn√°mka');
        script.setAttribute('theme', 'github-light');
        script.setAttribute('crossorigin', 'anonymous');
        script.async = true;
        
        container.appendChild(script);
    }

   async function fetchAllNotes() {
    const repo = "maty535/urbarDulova";
    const notesMap = {};
    const response = await fetch(`https://api.github.com/repos/${repo}/issues?state=all&labels=pozn√°mka&per_page=20`);
    const issues = await response.json();

    for (const issue of issues) {
        let commentsList = [];
        
        // Stiahneme koment√°re pre dan√© issue
        if (issue.comments > 0) {
            const commRes = await fetch(issue.comments_url);
            const comments = await commRes.json();
            
            commentsList = comments
                .filter(c => c.user.login !== 'utterances-bot') // Ignorujeme bota
                .map(c => ({
                    text: c.body,
                    date: new Date(c.created_at).toLocaleDateString('sk-SK', {
                        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    })
                }));
        }
        
        notesMap[issue.title] = commentsList;
    }
        return notesMap;
    }

    async function loadCommentsForOwner(ownerId, url) {
            const target = document.getElementById(`notes-list-${ownerId}`);
            target.innerHTML = `<div style="padding:10px; font-size:0.8rem; color: #666;">Naƒç√≠tavam z√°znamy...</div>`;
            
            try {
                const res = await fetch(url);
                const comments = await res.json();
                
                const html = comments
                    .filter(c => c.user.login !== 'utterances-bot')
                    .map(c => `
                        <div class="note-card">
                            <div class="note-body">
                                <span class="note-icon">üìù</span>
                                <div class="markdown-text">${marked.parse(c.body)}</div>
                                <div class="note-date-footer">${new Date(c.created_at).toLocaleString('sk-SK', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                            </div>
                        </div>
                    `).join('');
        
                target.innerHTML = `
                    <div class="notes-wrapper">
                        ${html}
                        <div style="text-align:center">
                           <button class="btn-edit-note" style="text-decoration:none; color:#94a3b8" onclick="document.getElementById('notes-list-${ownerId}').innerHTML=''">[ skry≈• ]</button>
                        </div>
                    </div>`;
            } catch (e) {
                target.innerHTML = `<div style="color:red; font-size:0.8rem;">Nepodarilo sa naƒç√≠ta≈• pozn√°mky.</div>`;
            }
        }

    async function fetchNotesInfo() {
        const repo = "maty535/urbarDulova";
        const notesInfo = {}; // Objekt, kde kƒæ√∫ƒç bude ownerId a hodnota poƒçet koment√°rov
        
        try {
            const response = await fetch(`https://api.github.com/repos/${repo}/issues?state=all&labels=pozn√°mka&per_page=100`);
            const issues = await response.json();
    
            issues.forEach(issue => {
                notesInfo[issue.title] = {
                    count: issue.comments,
                    url: issue.comments_url // Odlo≈æ√≠me si URL pre neskor≈°ie naƒç√≠tanie
                };
            });
            return notesInfo;
        } catch (err) {
            console.error("Chyba pri zis≈•ovan√≠ pozn√°mok:", err);
            return {};
        }
    }
    
   function doSearch() {
        const term = document.getElementById('search').value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        
        const filtered = ownersData.filter(i => {
            // 1. Textov√Ω filter (meno, d√°tum...)
            const searchString = (i.name + (i.maiden || "") + i.dob).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const matchesText = searchString.includes(term);
            
            // 2. Filter podƒæa pozn√°mok
            const ownerId = generateOwnerId(i.name, i.dob);
            const hasNotes = globalNotes[ownerId] && globalNotes[ownerId].count > 0;
            
            let matchesNotes = true;
            if (currentNoteFilter === 'with') matchesNotes = hasNotes;
            if (currentNoteFilter === 'without') matchesNotes = !hasNotes;
            
            return matchesText && matchesNotes;
        });
        
        render(filtered, globalNotes);
    }

    let currentNoteFilter = 'all'; // Mo≈ænosti: 'all', 'with', 'without'

    function setNoteFilter(type) {
        currentNoteFilter = type;
        
        // Vizualiz√°cia akt√≠vneho tlaƒçidla
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`filter-${type}`).classList.add('active');
        
        doSearch(); // Znovu prefiltrujeme d√°ta
    }

    // Funkcia na aktualiz√°ciu poƒçtov v tlaƒçidl√°ch
    function updateFilterCounts() {
        const total = ownersData.length;
        let withNotes = 0;
    
        ownersData.forEach(item => {
            const id = generateOwnerId(item.name, item.dob);
            if (globalNotes[id] && globalNotes[id].count > 0) {
                withNotes++;
            }
        });
    
        document.getElementById('count-all').innerText = `(${total})`;
        document.getElementById('count-with').innerText = `(${withNotes})`;
        document.getElementById('count-without').innerText = `(${total - withNotes})`;
    }

    async function refreshData() {
        const btn = document.getElementById('refresh-btn');
        btn.classList.add('loading'); // Prid√° triedu loading, ktor√° spust√≠ rot√°ciu cez CSS
        btn.disabled = true;
    
        try {
            globalNotes = await fetchNotesInfo();
            updateFilterCounts();
            doSearch();
        } catch (err) {
            console.error("Refresh zlyhal:", err);
        } finally {
            // Poƒçk√°me chv√≠ƒæu, aby anim√°cia vyzerala prirodzene
            setTimeout(() => {
                btn.classList.remove('loading');
                btn.disabled = false;
            }, 500);
        }
    }
    
    async function initApp() {

        const statsElement = document.getElementById('stats');
        
        try {
            // 1. Naƒç√≠tanie d√°t
            const response = await fetch('rozdiely.json');
            ownersData = await response.json();

            // 2. Naƒç√≠tanie pozn√°mok
            globalNotes = await fetchNotesInfo();
            updateFilterCounts(); 
            
            // 3. AKTUALIZ√ÅCIA TEXTU (Namiesto "Naƒç√≠tavam d√°ta...")
            if (statsElement) {
                statsElement.innerHTML = `N√°jden√Ωch <strong>${ownersData.length}</strong> vlastn√≠kov s rozdielnymi podielmi naprieƒç LV.<i class="fa-solid fa-circle-question info-trigger" onclick="toggleInfoBox()" style="color: #64748b; font-size: 1.2rem; cursor: pointer;" title="Viac inform√°ci√≠ o metodike"></i>`;
            }
    
            // 3. Kontrola URL parametra "search"
            const urlParams = new URLSearchParams(window.location.search);
            const initialSearch = urlParams.get('search');
    
            if (initialSearch) {
                // Vlo≈æ√≠me text z URL do tvojho search inputu
                const searchInput = document.getElementById('search');
                if (searchInput) {
                    searchInput.value = initialSearch;
                    
                    // Spust√≠me tvoju existuj√∫cu funkciu na vyhƒæad√°vanie
                    // (keƒè≈æe ownersData a globalNotes s√∫ u≈æ naƒç√≠tan√©, render prebehne spr√°vne)
                    doSearch(); 
                }
            } else {
                // Ak v URL niƒç nie je, vykresl√≠me v≈°etko
                await render(ownersData, globalNotes);
            }
    
        } catch (err) {
            console.error("Chyba pri ≈°tarte aplik√°cie:", err);
        }
    }
    // Spustenie aplik√°cie
    initApp();
    
</script>

</body>
</html>
