<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit podielov vlastníkov</title>
    <style>
        @media (max-width: 600px) {

            .quick-note {
                font-size: 1.05rem; /* Čitateľnejšie na mobile */
            }
            /* 1. HLAVIČKA: Dátum pod nadpisom, bez prekrývania */
            div[style*="position: relative"] {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                padding-bottom: 15px !important;
            }
            span[style*="position: absolute"] {
                position: static !important;
                transform: none !important;
                margin-top: 8px;
            }

            /* Kľúčová zmena pre oddelenie riadkov */
            .share-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                padding: 12px 5px !important;
                background: transparent !important; /* Čisté biele pozadie */
                border-bottom: 1px solid #b91c1c !important; /* Tenká, ale ostrá červená čiara */
            }

            .share-row:last-child {
                border-bottom: none !important; /* Posledný riadok v rámci jedného vlastníka už čiaru nepotrebuje */
            }
            /* 3. DÁTA: Každé na svojom riadku */
            .fraction-col, .percent-col, .lv-info {
                width: 100% !important;
                padding: 4px 0 !important;
                text-align: center !important;
                border: none !important;
            }

            /* 2. SKRYTIE TEXTU "na listoch:" */
            /* V tvojom renderi je to v <span style="color: var(--text-muted)">na listoch:</span> */
            .lv-info span[style*="color: var(--text-muted)"],
            .dob-tag span[style*="color: var(--text-muted)"] {
                display: none !important;
            }

            .percent-col {
                color: var(--primary-color) !important;
                font-size: 1.2rem !important;
                font-weight: 800 !important;
            }

        .lv-numbers {
                font-size: 1.25rem !important;
                display: block;
                margin-top: 5px;
            }
            /* Základný štýl pre ikonu */
            .lv-icon {
                color: var(--primary-color); /* Použije tvoju červenú */
                font-weight: bold;
                margin-right: 8px;
            }
            /* Šípka na mobile môže byť o niečo väčšia pre lepšiu navigáciu oka */
            .lv-icon {
                font-size: 1.2rem;
                display: inline-block;
                vertical-align: middle;
            }
            .lv-arrow {
                font-size: 1.5rem;
                display: inline-block !important; /* Na mobile sa šípka zobrazí */
                color: #b91c1c; /* Ostrá červená */
                margin-right: 5px;
                vertical-align: middle;
                font-weight: 900;
            }
        }
        /* 1. ZÁKLADNÉ NASTAVENIE (Desktop) */
        .quick-note {
            white-space: pre-wrap; /* KĽÚČOVÉ: zachová riadkovanie a entery */
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            margin: 10px 0;
            line-height: 1.5; /* Lepšia čitateľnosť */
        }
        
        .btn-edit-note {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 5px;
        }
        .lv-arrow { display: none;}  /* Šípka je predvolene skrytá */
        :root { --primary-color: #b91c1c; --bg-body: #f8fafc; --text-muted: #64748b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 40px; background: var(--bg-body); color: #334155; }
        .container { max-width: 1150px; margin: auto; }
        
        h1 { font-size: 2.2rem; color: var(--primary-color); margin-bottom: 5px; font-weight: 800; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .sub-header { font-size: 1.1rem; color: #475569; margin-bottom: 25px; font-weight: 600; }
        
        .search-box { width: 100%; padding: 12px 20px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; margin-bottom: 25px; outline: none; box-sizing: border-box; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 6px solid var(--primary-color); position: relative; }
        .owner-name { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
        
        /* Spoločný štýl pre interaktívne štítky */
        .tag { display: inline-block; padding: 3px 10px; border-radius: 6px; font-weight: 700; font-size: 0.85rem; margin-left: 10px; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; }
        
        .maiden-tag { background: #fef2f2; color: #b91c1c; border-color: #fee2e2; }
        .maiden-tag:hover { background: #fee2e2; transform: translateY(-1px); }
        
        .dob-tag { background: #f1f5f9; color: #475569; border-color: #e2e8f0; font-style: normal !important; }
        .dob-tag:hover { background: #e2e8f0; color: #1e293b; transform: translateY(-1px); }

        .mismatch-box { background: #fff5f5; border: 1px solid #fee2e2; border-radius: 10px; margin-top: 15px; overflow: hidden; }
        
        .share-row { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid #fee2e2; }
        .share-row:last-child { border-bottom: none; }

        .fraction-col { width: 100px; display: flex; justify-content: center; }
        .percent-col { width: 140px; font-family: 'Courier New', monospace; font-weight: 700; color: #b91c1c; font-size: 1.05rem; text-align: right; padding-right: 35px; }

        .lv-info { flex: 1; font-size: 1.05rem; border-left: 2px solid #fee2e2; padding-left: 25px; }
        .lv-numbers { font-weight: 700; color: var(--primary-color); }

        .fraction { display: inline-flex; flex-direction: column; vertical-align: middle; align-items: center; font-size: 0.95em; line-height: 1.1; font-weight: bold; }
        .fraction .num { border-bottom: 1.5px solid #1e293b; padding: 0 3px; }
        .fraction .den { padding: 0 3px; }
        .nema-val { font-weight: 800; color: #64748b; font-size: 1.1rem; }

        /* Hlavný kontajner pre všetky poznámky */
.notes-box {
    margin: 15px 0;
    background: #fdfdfd;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    overflow: hidden; /* Aby rohy obsahu neprečnievali cez border */
}

/* Hlavička boxu */
.notes-header {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    padding: 6px 12px;
    font-size: 0.7rem;
    font-weight: bold;
    color: #64748b;
    text-transform: uppercase;
}

    /* Vnútro boxu */
    .notes-content {
        padding: 0 12px;
    }
    
    /* Jednotlivý záznam */
    .note-entry {
        padding: 10px 0;
    }
    
    .note-meta {
        font-size: 0.65rem;
        color: #94a3b8;
        margin-bottom: 4px;
        font-family: 'Courier New', Courier, monospace;
    }
    
    .note-text {
        font-size: 0.85rem;
        color: #334155;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    
    /* Oddeľovacia čiara medzi poznámkami */
    .note-sep {
        border: 0;
        border-top: 1px dashed #e2e8f0;
        margin: 0;
    }
    </style>
</head>
<body>

<div class="container">
    <div style="position: relative; border-bottom: 2px solid var(--primary-color); margin-bottom: 25px; padding-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
        <h1 style="margin: 0; border-bottom: none; padding: 0;">Nekonzistencie v podieloch vlastníkov</h1>
        <span style="background: #1e293b; color: white; padding: 5px 15px; border-radius: 6px; font-size: 0.85rem; font-weight: 800; letter-spacing: 0.5px; white-space: nowrap;">
            STAV K 28. 02. 2026
        </span>
    </div>
    <div class="sub-header" id="stats">Načítavam dáta...</div>
    
    <input type="text" id="search" class="search-box" placeholder="Hľadať podľa mena, rodného mena alebo dátumu..." onkeyup="doSearch()">
    
    <div id="results"></div>
</div>

<script>
    let ownersData  = [];
    let globalNotes = {};  // Globálna premenná pre poznámky

    function formatFraction(shareStr) {
        if (shareStr === "Nemá") return '<div class="nema-val">Nemá</div>';
        const match = shareStr.match(/{(\d+)}{(\d+)}/);
        if (match) return `<div class="fraction"><span class="num">${match[1]}</span><span class="den">${match[2]}</span></div>`;
        return shareStr;
    }

    // Univerzálna funkcia pre nastavenie filtra
    function setFilter(value) {
        const searchInput = document.getElementById('search');
        searchInput.value = value;
        doSearch();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function generateOwnerId(name, dob) {
        return `${name}-${dob}`
            .toLowerCase()
            .normalize("NFD")                // Rozloží znaky (á -> a + ´)
            .replace(/[\u0300-\u036f]/g, "") // Odstráni diakritické znamienka
            .replace(/\s+/g, '-')            // Medzery nahradí pomlčkami
            .replace(/[^a-z0-9-]/g, '');     // Odstráni všetko ostatné okrem alfanumeriky a pomlčiek
    }

    function removeAccents(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }
   async function render(data, notesMap = {}) {
        const out = document.getElementById('results');
        document.getElementById('stats').innerText = `Nájdených ${data.length} vlastníkov s rozdielnymi podielmi naprieč LV.`;
    
        out.innerHTML = data.map(item => {
            // --- SEM VKLADÁME LOGIKU PRE KAŽDÚ KARTU ---
            const ownerId = generateOwnerId(item.name, item.dob);
            const comments = notesMap[ownerId] || [];
            // ------------------------------------------
    
            return `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="owner-name">${item.name}</span>
                            ${item.maiden ? `<span class="tag maiden-tag" onclick="setFilter('${item.maiden}')" title="Filtrovať rodné meno">r. ${item.maiden}</span>` : ''}
                        </div>
                        <div class="tag dob-tag" onclick="setFilter('${item.dob}')" title="Filtrovať dátum narodenia">
                            <span style="color: var(--text-muted)">Nar.:</span> ${item.dob}
                        </div>
                    </div>
                    <div class="mismatch-box">
                        ${item.details.map(d => {
                            const pMatch = d.share.match(/\(([\d\.]+)%\)/);
                            const percent = pMatch ? pMatch[1] : "";
                            return `
                                <div class="share-row">
                                    <div class="fraction-col">${formatFraction(d.share)}</div>
                                    <div class="percent-col">${percent ? percent + ' %' : ''}</div>
                                    <div class="lv-info">
                                        <span class="lv-arrow">↓</span>
                                        <span class="lv-label" style="color: var(--text-muted)">na listoch:</span>
                                        <span class="lv-numbers">${d.lvs.join(', ')}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
    
                    ${comments.length > 0 ? `
                        <div class="notes-box">
                            <div class="notes-header">Poznámky a história</div>
                            <div class="notes-content">
                                ${comments.map((c, index) => `
                                    <div class="note-entry">
                                        <div class="note-meta">${c.date}</div>
                                        <div class="note-text">${c.text}</div>
                                    </div>
                                    ${index < comments.length - 1 ? '<hr class="note-sep">' : ''}
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
    
                    <div id="edit-ctrl-${ownerId}" style="margin-top: 10px; text-align: right;">
                        <button class="btn-edit-note" onclick="activateUtterances('${ownerId}')">
                            ${comments.length > 0 ? 'Upraviť poznámku' : '+ Pridať poznámku'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // 3. Funkcia, ktorá aktivuje plnohodnotné Utterances pri kliknutí na tlačidlo
    function activateUtterances(ownerId) {
        const container = document.getElementById(`edit-ctrl-${ownerId}`);
        container.innerHTML = '<p style="font-size:0.8rem; color:var(--text-muted)">Načítavam editor...</p>';
        
        const script = document.createElement('script');
        script.src = "https://utteranc.es/client.js";
        script.setAttribute('repo', 'maty535/urbarDulova'); // <--- SEM DOPLŇ SVOJE
        script.setAttribute('issue-term', ownerId);
        script.setAttribute('label', 'poznámka');
        script.setAttribute('theme', 'github-light');
        script.setAttribute('crossorigin', 'anonymous');
        script.async = true;
        
        container.appendChild(script);
    }

   async function fetchAllNotes() {
    const repo = "maty535/urbarDulova";
    const notesMap = {};
    const response = await fetch(`https://api.github.com/repos/maty535/urbarDulova/issues?state=all&labels=poznámka&per_page=20`);
    const issues = await response.json();

    for (const issue of issues) {
        let commentsList = [];
        
        // Stiahneme komentáre pre dané issue
        if (issue.comments > 0) {
            const commRes = await fetch(issue.comments_url);
            const comments = await commRes.json();
            
            commentsList = comments
                .filter(c => c.user.login !== 'utterances-bot') // Ignorujeme bota
                .map(c => ({
                    text: c.body,
                    date: new Date(c.created_at).toLocaleDateString('sk-SK', {
                        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    })
                }));
        }
        
        notesMap[issue.title] = commentsList;
    }
    return notesMap;
}
    
    function doSearch() {
        const term = document.getElementById('search').value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const filtered = ownersData.filter(i => {
            const searchString = (i.name + (i.maiden || "") + i.dob).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            return searchString.includes(term);
        });
        render(filtered, globalNotes);
    }


    async function initApp() {
        try {
            // 1. Načítanie dát
            const response = await fetch('rozdiely.json');
            ownersData = await response.json();
            
            // 2. Načítanie poznámok
            globalNotes = await fetchAllNotes();
    
            // 3. Kontrola URL parametra "search"
            const urlParams = new URLSearchParams(window.location.search);
            const initialSearch = urlParams.get('search');
    
            if (initialSearch) {
                // Vložíme text z URL do tvojho search inputu
                const searchInput = document.getElementById('search');
                if (searchInput) {
                    searchInput.value = initialSearch;
                    
                    // Spustíme tvoju existujúcu funkciu na vyhľadávanie
                    // (keďže ownersData a globalNotes sú už načítané, render prebehne správne)
                    doSearch(); 
                }
            } else {
                // Ak v URL nič nie je, vykreslíme všetko
                await render(ownersData, globalNotes);
            }
    
        } catch (err) {
            console.error("Chyba pri štarte aplikácie:", err);
        }
    }
    // Spustenie aplikácie
    initApp();
    
</script>

</body>
</html>
